<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ if .Title }}{{ .Title }} · {{ end }}{{ site.Title }}</title>
    <meta name="description" content="Kid-friendly dual-language classics: simple English + Español." />
    <link rel="icon" type="image/png" href="https://imagedelivery.net/uoQWLs2DQGCKz-4i8TTorQ/cec67720-b2ed-43fc-4099-c0987a94fb00/public" />
    <link rel="shortcut icon" type="image/png" href="https://imagedelivery.net/uoQWLs2DQGCKz-4i8TTorQ/cec67720-b2ed-43fc-4099-c0987a94fb00/public" />
    <link rel="apple-touch-icon" href="https://imagedelivery.net/uoQWLs2DQGCKz-4i8TTorQ/cec67720-b2ed-43fc-4099-c0987a94fb00/public" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <!-- Dark Mode MUST come BEFORE main.css -->
    <style>
      /* Dark mode - default - HIGHEST PRIORITY */
      html:not(.light-mode) body,
      body:not(.light-mode) {
        background-color: #1a1611 !important;
        background: #1a1611 !important;
        color: #e8d7c3 !important;
      }
      
      /* Override the --bg variable that main.css uses */
      body:not(.light-mode) {
        --bg: #1a1611 !important;
        --ink: #e8d7c3 !important;
        --ink-dim: #a89577 !important;
      }
      
      /* Light mode - when toggled */
      html.light-mode body,
      body.light-mode {
        background-color: #fffdf8 !important;
        background: #fffdf8 !important;
        color: #212121 !important;
        --bg: #fffdf8 !important;
        --ink: #212121 !important;
        --ink-dim: #666 !important;
      }
    </style>
    
    {{ $styles := resources.Get "css/main.css" | resources.ExecuteAsTemplate "css/main.css" . | resources.Minify | resources.Fingerprint }}
    <link rel="stylesheet" href="{{ $styles.RelPermalink }}" integrity="{{ $styles.Data.Integrity }}" />
    
    <!-- Dark Mode Additional Styles - AFTER main.css -->
    <style>
      /* Icon visibility */
      .theme-toggle-btn .sun-icon { display: none !important; }
      .theme-toggle-btn .moon-icon { display: block !important; }
      body.light-mode .theme-toggle-btn .sun-icon { display: block !important; }
      body.light-mode .theme-toggle-btn .moon-icon { display: none !important; }
      
      /* Dark mode for elements */
      body:not(.light-mode) .chapter-top-bar {
        background: rgba(26, 22, 17, 0.98) !important;
      }
      
      body:not(.light-mode) .readable .bp {
        background: #252119 !important;
        border-left-color: #ffa94d !important;
      }
      
      body:not(.light-mode) .nav-card,
      body:not(.light-mode) .chapter-dropdown,
      body:not(.light-mode) .reading-settings-toggle,
      body:not(.light-mode) .theme-toggle-btn,
      body:not(.light-mode) .control-btn {
        background: #252119 !important;
        border-color: rgba(232, 215, 195, 0.1) !important;
        color: #e8d7c3 !important;
      }
      
      body:not(.light-mode) .reading-panel {
        background: #252119 !important;
      }
      
      /* Fix white background on main container */
      body:not(.light-mode) .container,
      body:not(.light-mode) .chapter,
      body:not(.light-mode) main {
        background: transparent !important;
      }
    </style>
    
    <link rel="stylesheet" href="{{ "css/pronunciation.css" | relURL }}" />
    <link rel="stylesheet" href="{{ "css/chapter-navigation.css" | relURL }}" />
    
    <!-- Apply theme immediately -->
    <script>
      (function() {
        var savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
          document.documentElement.classList.add('light-mode');
          document.body?.classList.add('light-mode');
        }
      })();
    </script>
  </head>
  <body class="lang-both">
    {{ partial "header.html" . }}
    <main class="container">
      {{ block "main" . }}{{ end }}
    </main>
    {{ partial "footer.html" . }}
    <script src="{{ "js/main.js" | relURL }}"></script>
    <script src="{{ "js/pronunciation-toggle.js" | relURL }}"></script>
    
    <!-- Dark mode settings panel integration -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Apply saved theme to body
        var savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
          document.body.classList.add('light-mode');
        } else {
          document.body.classList.remove('light-mode');
        }
        
        // Settings panel theme buttons
        var themeButtons = document.querySelectorAll('.theme-setting');
        themeButtons.forEach(function(btn) {
          btn.addEventListener('click', function() {
            var theme = this.getAttribute('data-theme');
            if (theme === 'light') {
              document.body.classList.add('light-mode');
            } else {
              document.body.classList.remove('light-mode');
            }
            localStorage.setItem('theme', theme);
            
            // Update button states
            themeButtons.forEach(function(b) {
              b.setAttribute('aria-pressed', b === btn ? 'true' : 'false');
            });
          });
        });
      });
    </script>
  </body>
  </html>