<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ if .Title }}{{ .Title }} Â· {{ end }}{{ site.Title }}</title>
    {{ partial "seo.html" . }}
    <link rel="icon" type="image/png" href="https://imagedelivery.net/uoQWLs2DQGCKz-4i8TTorQ/cec67720-b2ed-43fc-4099-c0987a94fb00/public" />
    <link rel="shortcut icon" type="image/png" href="https://imagedelivery.net/uoQWLs2DQGCKz-4i8TTorQ/cec67720-b2ed-43fc-4099-c0987a94fb00/public" />
    <link rel="apple-touch-icon" href="https://imagedelivery.net/uoQWLs2DQGCKz-4i8TTorQ/cec67720-b2ed-43fc-4099-c0987a94fb00/public" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    {{ $styles := resources.Get "css/main.css" | resources.ExecuteAsTemplate "css/main.css" . | resources.Minify | resources.Fingerprint }}
    <link rel="stylesheet" href="{{ $styles.RelPermalink }}" integrity="{{ $styles.Data.Integrity }}" />
    
    <link rel="stylesheet" href="{{ "css/pronunciation.css" | relURL }}" />
    <link rel="stylesheet" href="{{ "css/chapter-navigation.css" | relURL }}" />
  </head>
  <body class="lang-both">
    {{ partial "header.html" . }}
    <main class="container">
      {{ block "main" . }}{{ end }}
    </main>
    {{ partial "footer.html" . }}
    <script src="{{ "js/main.js" | relURL }}"></script>
    <script src="{{ "js/pronunciation-toggle.js" | relURL }}"></script>
    
    <!-- Force dark mode with immediate execution -->
    <script>
      (function() {
        function forceDarkMode() {
          // Body
          document.body.classList.add('dark-mode-active');
          document.body.style.backgroundColor = '#1a1611';
          document.body.style.color = '#f0e0d0';
          
          // Force header styles
          var header = document.querySelector('.site-header');
          if (header) {
            // Use setAttribute to force override
            header.setAttribute('style', 'background-color: #1f1b16 !important; background: #1f1b16 !important; border-bottom: 3px solid #ff9944 !important;');
            console.log('Dark mode applied to header');
          } else {
            console.log('Header not found, retrying...');
            setTimeout(forceDarkMode, 100);
          }
          
          // Brand title
          var title = document.querySelector('.site-header .title');
          if (title) {
            title.style.color = '#ffd4a3';
          }
          
          // Nav links
          document.querySelectorAll('.site-header .site-nav a').forEach(function(link) {
            link.style.color = '#f0e0d0';
          });
          
          // Footer
          var footer = document.querySelector('.site-footer');
          if (footer) {
            footer.setAttribute('style', 'background-color: #1f1b16 !important; border-top: 3px solid #ff9944 !important;');
          }
        }
        
        function forceLightMode() {
          document.body.classList.remove('dark-mode-active');
          document.body.style.backgroundColor = '';
          document.body.style.color = '';
          
          var header = document.querySelector('.site-header');
          if (header) header.removeAttribute('style');
          
          var title = document.querySelector('.site-header .title');
          if (title) title.style.color = '';
          
          document.querySelectorAll('.site-header .site-nav a').forEach(function(link) {
            link.style.color = '';
          });
          
          var footer = document.querySelector('.site-footer');
          if (footer) footer.removeAttribute('style');
        }
        
        // Check theme and apply
        if (localStorage.getItem('theme') !== 'light') {
          forceDarkMode();
          // Run again after a delay to ensure it sticks
          setTimeout(forceDarkMode, 500);
          setTimeout(forceDarkMode, 1000);
        } else {
          forceLightMode();
        }
        
        // Make these functions global for toggle button
        window.applyDarkMode = forceDarkMode;
        window.applyLightMode = forceLightMode;
      })();
    </script>
  </body>
  </html>
